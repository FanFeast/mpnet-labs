from typing import Dict

import numpy as np
import torch
from torch.utils.data import Dataset


class MPNetToyDataset(Dataset):
    """
    Simple Dataset wrapper around the .npz generated by dataset_gen.py.

    Expects keys:
      - "grids": (N, 1, H, W) float32
      - "x_cur": (N, 2) float32
      - "x_goal": (N, 2) float32
      - "x_next": (N, 2) float32
    """

    def __init__(self, npz_path: str):
        super().__init__()
        data = np.load(npz_path)
        self.grids = data["grids"]  # (N, 1, H, W)
        self.x_cur = data["x_cur"]  # (N, 2)
        self.x_goal = data["x_goal"]  # (N, 2)
        self.x_next = data["x_next"]  # (N, 2)

        assert self.grids.shape[0] == self.x_cur.shape[0]
        assert self.grids.shape[0] == self.x_goal.shape[0]
        assert self.grids.shape[0] == self.x_next.shape[0]

    def __len__(self) -> int:
        return self.grids.shape[0]

    def __getitem__(self, idx: int) -> Dict[str, torch.Tensor]:
        grid = torch.from_numpy(self.grids[idx])  # (1, H, W)
        x_cur = torch.from_numpy(self.x_cur[idx])  # (2,)
        x_goal = torch.from_numpy(self.x_goal[idx])  # (2,)
        x_next = torch.from_numpy(self.x_next[idx])  # (2,)

        return {
            "grid": grid,
            "x_cur": x_cur,
            "x_goal": x_goal,
            "x_next": x_next,
        }
